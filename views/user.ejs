<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/assets/images/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg" />
  <link rel="shortcut icon" href="/assets/images/favicon.ico" />
  <link rel="manifest" href="/assets/images/site.webmanifest" />

  <title>TailTalk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/main.css" />
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">üêæ TailTalk</a>
      <div class="nav-buttons">
        <a href="/main" class="btn btn-custom">All posts</a>
        <a href="/logout" class="btn btn-custom">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-5 mb-5">
    <h2 class="mb-4">Hey, <%= username %>!</h2>

    <div class="row">
      <!-- Left Column: Posts -->
      <div class="col-md-8">

        <!-- Dynamic Posts -->
        <% if (posts && posts.length !== 0) { %>
          <% posts.forEach(post=> { %>
            <div class="card post-card p-3 mb-4">
              <% if (post.image) { %> 
                <img src="<%= post.image %>" class="card-img-top post-img mb-2" alt="Post Image" />
                <% } %>
                  <div>
                    <h5 class="card-title mb-1">
                      <%= post.title %>
                    </h5>
                    <p class="text-muted mb-2" style="font-size: 0.8rem;">
                      <%= new Date(post.created_at).toLocaleString("en-IN", { year: "numeric" , month: "short" , day: "numeric" ,
                        hour: "numeric" , minute: "2-digit" , hour12: true }) %>
                    </p>
                  
                  
                    <p class="card-text">
                      <%= post.content %>
                    </p>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <form class="like-form" action="/like/<%= post.id %>" method="POST">
                      <button class="btn like-btn <%= likedPostIds.includes(post.id) ? 'liked' : '' %>" 
                        type="button" data-post-id="<%= post.id %>">
                        ‚ù§Ô∏è <span id="like-count-<%= post.id %>"><%= post.like_count %></span> Likes
                      </button>
                    </form>
                  
                    <div class="d-flex gap-2">
                      <form action="/edit/<%= post.id %>" method="GET">
                        <button class="btn icon-btn" type="submit" title="Edit">
                          <img width="32" height="32" src="https://img.icons8.com/sf-black-filled/64/F25081/create-new.png"
                            alt="create-new" />
                        </button>
                      </form>
                      <form action="/delete/<%= post.id %>" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this post?');">
                        <button class="btn icon-btn" type="submit" title="Delete">
                          <img width="30" height="30" src="https://img.icons8.com/ios-glyphs/30/F25081/filled-trash.png"
                            alt="filled-trash" />
                        </button>
                      </form>
                    </div>
                  </div>
            </div>
            <% }) %>
              <% } %>
      </div>

      <!-- Right Column: About + Form -->
      <div class="col-md-4">
        <!-- About Me Card -->
      
        <div class="col-md-4" style="max-width: 415px; min-width: 100%;">
          <div class="card about-card p-3 mb-4">
            <h5 class="card-title">About Me</h5>
            <p id="aboutText" class="card-text">
              <%= aboutMe %>
            </p>
      
            <!-- Edit form (hidden by default) -->
            <form id="aboutForm" action="/update-about" method="POST" hidden>
              <textarea name="about" class="form-control mb-2" rows="3"><%= aboutMe %></textarea>
              <button type="submit" class="btn btn-success btn-sm">Save</button>
            </form>
            <button id="editBtn" class="btn post-btn mt-2" onclick="editAbout()">Edit</button>
          </div>
        </div>

        <!-- New Post Form -->
        <form class="card post-form p-3" action="/add-post" method="POST" enctype="multipart/form-data">
          <h5 class="card-title">
            Got something interesting? Write here...ü©∑
          </h5>
          <input class="form-control mb-2" type="text" name="title" placeholder="Post title" required />
          <textarea class="form-control mb-2" name="content" placeholder="Write something cute..." rows="8"
            required></textarea>
          <input class="form-control mb-2" type="file" name="image" accept="image/*" />
          <button class="btn post-btn w-100" type="submit">Post</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <%- include("partials/footer.ejs")%>
  <script>
    function editAbout() {
      document.getElementById("aboutText").hidden = true;
      document.getElementById("editBtn").hidden = true;
      document.getElementById("aboutForm").hidden = false;
    }

    document.addEventListener("DOMContentLoaded", () => {

      document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function () {
          let postId = this.getAttribute('data-post-id');


          fetch(`/like/${postId}`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/json',
            },
            credentials: "same-origin",
            body: JSON.stringify({ post_id: postId })
          })
            .then(res => {
              if (!res.ok) {
                if (res.status === 401) {
                  window.location.href = "/login";
                }
                throw new Error(`HTTP ${res.status}`);
              }
              return res.json();
            })
            .then(data => {
              document.getElementById(`like-count-${postId}`).textContent = data.like_count;

              if (data.liked) {
                this.classList.add("liked");
              } else {
                this.classList.remove("liked");
              }
            })
            .catch(error => {
              console.error('Error:', error);
              this.disabled = false;
            });
        });
      });

    });
  </script>
</body>

</html>